$(document).ready(function () {
    // Manter selecionado o projeto escolhido
    loadScan();

    $('#selectedCompany').change(function () {
        const selectedCompany = $('#selectedCompany').val();
        const tagSelectCompany = $('#selectedCompany');
        const companies = $('#companies').data('value');;
        const tagSelectProjects = $("#selectedProject");
        const labelProject = $('#projetos-label');

        updateProjectSelector(companies, selectedCompany, tagSelectCompany, tagSelectProjects, labelProject);
    });

    $('#selectedProject').change(function () {
        const selectedProject = $('#selectedProject').val();
        const searchButton = $('#search-button');

        if (selectedProject.length > 0) {
            searchButton.show();
        }
        else {
            searchButton.hide();
        }
    });

    $(document).on('click', '#search-button', function () {
        const selectedCompany = $('#selectedCompany').val();
        const selectedProject = $("#selectedProject").val();

        saveItem('selectedCompany', selectedCompany);
        saveItem('selectedProject', selectedProject);
    });

});

function loadScan() {
    const companies = $('#companies').data('value');
    const tagSelectCompany = $('#selectedCompany')
    const tagSelectProjects = $("#selectedProject");
    const labelProject = $('#projetos-label');


    let selectedCompany = loadItem('selectedCompany');
    let selectedProject = loadItem('selectedProject');

    if (!selectedCompany || !selectedProject) {
        return;
    }

    selectedCompany = JSON.parse(selectedCompany);
    selectedProject = JSON.parse(selectedProject);

    updateProjectSelector(
        companies,
        selectedCompany,
        tagSelectCompany,
        tagSelectProjects,
        labelProject,
        selectedProject,
    );
}

function updateProjectSelector(
    companies,
    selectedCompany,
    tagSelectCompany,
    tagSelectProjects,
    labelProject,
    selectedProject = null) {
    let searchButton = $('#search-button');
    let companiesCopy = deepCopy(companies).replace(/'/g, '"');

    if (companiesCopy) {
        let companiesJson = JSON.parse(companiesCopy);

        let listProjects = selectedCompanyProjectList(companiesJson, selectedCompany);

        if (listProjects != 0) {
            if (tagSelectProjects.children().length > 1) {
                removeExtraElementsById("extra");
            }

            listProjects.forEach(function (project) {
                tagSelectProjects.append('<option id="extra" value="' + project.id + '">' + project.name + '</option>');
            });

            labelProject.show();
            tagSelectProjects.show();

            if (selectedProject) {
                let companyIndex = findIndexInSelect(tagSelectCompany[0], selectedCompany);
                let projectIndex = findIndexInSelect(tagSelectProjects[0], selectedProject);
                tagSelectProjects[0].selectedIndex = projectIndex;
                tagSelectCompany[0].selectedIndex = companyIndex;
                searchButton.show();
            }
        } else {
            labelProject.hide();
            tagSelectProjects.hide();
            searchButton.hide();
        }
    }

}

function companyProjects(company) {
    let arrayProjects = [];

    if (company.projects != 0) {

        company.projects.forEach(function (project) {
            arrayProjects.push(project);
        })
    }

    return arrayProjects;
}

function deepCopy(param) {
    let copy = JSON.parse(JSON.stringify(param));
    return copy;
}

function selectedCompanyProjectList(companiesJson, selectedCompany) {
    let listProjects = [];

    companiesJson.forEach(function (company) {
        if (company.id == selectedCompany) {
            listProjects = companyProjects(company);
        }
    });

    return listProjects;
}

function removeExtraElementsById(id) {
    $('[id="' + `${id}` + '"]').remove();
}

