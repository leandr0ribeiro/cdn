$(document).ready(function () {
  $('#pentestTable tbody').on("click", ".viewButton", function (event) {
    const tabela = $('#pentestTable').DataTable();
    const row = event.target.closest('tr');
    const rowData = tabela.row(row).data();

    const vulnerabilityData = {
      "Host": rowData.host,
      "Criticidade": rowData.severity.severity,
      "Porta": rowData.port,
      "CVSS": rowData.cvss,
      "Nome": rowData.name,
      "Status": getStatusValue(rowData.status),
      "Responsavel": rowData.responsible,
      "Vulnerabilidade": rowData.name,
      "Referência": rowData.reference,
      "Mitigação": rowData.mitigation,
      "Impacto": rowData.impact,
      "Evidência": rowData.evidence,
    };

    const restestData = {
      "Evidência": rowData.retest_evidence,
    };

    if (rowData.retest_requester) {
      restestData["Solicitante"] = rowData.retest_requester;
    }else if(rowData.retest_date){
      restestData["Data do Reteste"] = rowData.retest_date;
    }

    fillTabContent("vulnerability", vulnerabilityData);
    fillTabContent("retest", restestData);
  });
});


function fillTabContent(tabId, data) {
  let container = document.getElementById(tabId);
  container.innerHTML = '';

  const containerFluid = document.createElement("div");
  containerFluid.className = "container-fluid";

  for (const campo in data) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "row mt-2";

    const colDiv = document.createElement("div");
    colDiv.className = "col";

    const label = document.createElement("label");
    label.className = "col-form-label";
    label.textContent = campo;

    var input;
    if (campo === "Evidência") {
      if (data[campo] != "") {
        input = document.createElement("div");
        input.style.whiteSpace = "pre-wrap";
        input.className = "form-control";
        input.innerHTML = data[campo]; // Renderiza o conteúdo HTML
      } else {
        input = document.createElement("input");
        input.className = "form-control text-center";
        input.type = "text";
        input.id = campo.toLowerCase();
        input.value = "Sem evidência";
      }
    } else {
      if (
        campo === "Impacto" ||
        campo === "Mitigação" ||
        campo === "Referência"
      ) {
        input = document.createElement("textarea");
        input.rows = 4;
        input.className = "form-control";
        input.value = data[campo];
      } else {
        input = document.createElement("input");
        input.className = "form-control";
        input.type = "text";
        input.id = campo.toLowerCase();
        input.value = data[campo];
      }
    }

    input.setAttribute("readonly", "readonly")
    colDiv.appendChild(label);
    colDiv.appendChild(input);
    rowDiv.appendChild(colDiv);
    containerFluid.appendChild(rowDiv);
  }
  container.appendChild(containerFluid);
}

$(document).on('click', '#edit-vul', function () {
  $('#id_project').removeAttr('disabled');
});

function getCriticidadeValue(value) {
  if (value.includes("Low")) {
    return "Low";
  } else if (value.includes("Medium")) {
    return "Medium";
  } else if (value.includes("High")) {
    return "High";
  } else if (value.includes("Critical")) {
    return "Critical";
  }

  return value;
}

function getStatusValue(value) {
  if (value == 1) {
    return "Falha identificada";
  } else if (value == 2) {
    return "Em correção";
  } else if (value == 3) {
    return "Falha de reteste";
  } else if (value == 4) {
    return "Risco aceito";
  } else if (value == 5) {
    return "Reteste";
  } else if (value == 6) {
    return "Concluído";
  }
}
